import pandas as pd
import os
import time
import streamlit as st
import matplotlib.pyplot as plt
from datetime import datetime
from streamlit_autorefresh import st_autorefresh

# Auto-refresh every 2 seconds
st_autorefresh(interval=2000, key="refresh")

# Get current date
ts = time.time()
date = datetime.fromtimestamp(ts).strftime("%d-%m-%Y")

# Attendance Folder Path
attendance_folder = "Attendance"

# Display header with current date
st.header(f"Attendance Record for {date}")

# List all attendance files
attendance_files = [f for f in os.listdir(attendance_folder) if f.startswith("Attendance_") and f.endswith(".csv")]

# Initialize an empty DataFrame to store combined data
all_data = []

# Read each attendance file and extract date-wise attendance records
for file in attendance_files:
    file_path = os.path.join(attendance_folder, file)

    # Read the file
    df = pd.read_csv(file_path)

    # Extract date from the filename (format: Attendance_DD-MM-YYYY.csv)
    file_date = file.replace("Attendance_", "").replace(".csv", "")

    # Append data
    for name in df["NAME"].unique():
        all_data.append({"DATE": file_date, "NAME": name})

# Convert list to DataFrame
df_daywise = pd.DataFrame(all_data)

# Sort data by date
df_daywise["DATE"] = pd.to_datetime(df_daywise["DATE"], format="%d-%m-%Y")
df_daywise = df_daywise.sort_values("DATE")

# Display Table
st.subheader("Day-wise Attendance List")
st.dataframe(df_daywise)

# Plot Day-wise Attendance Graph
st.subheader("Attendance Trend Over Time (Name vs Date)")
fig, ax = plt.subplots(figsize=(10, 6))

# Scatter plot to show name attendance over dates
ax.scatter(df_daywise["DATE"], df_daywise["NAME"], marker="o", color="b")

ax.set_xlabel("Date")
ax.set_ylabel("Name")
ax.set_title("Attendance Record (Date vs Name)")

plt.xticks(rotation=45)  # Rotate x-axis labels for better readability

# Show the plot
st.pyplot(fig)
